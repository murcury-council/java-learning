# RPC 协议

RPC 协议和 HTTP 协议都属于应用层协议

## 协议的作用

##### *为什么需要协议，没有协议就不能通信吗？*

只有二进制才能在网络中传播，RPC 在请求发送到网络中之前，需要把方法调用的请求参数转成二进制，写入本地 Socket 中，然后被网卡发送到网络设备中。

在传输过程中，RPC 不会把请求参数的所有二进制数据整个一下子发送到对端机器上，中间可能会拆分成好几个数据包，也可能会合并其他请求的数据包（合并的前提是同一个 TCP 连接上的数据）。对于服务提供方来说，会从 TCP 通道里收到很多二进制数据，通过协议，就可以**确定消息的边界**，确定哪些数据是一个请求里的。

##### *为什么需要为 RPC 设计私有协议，不能用 HTTP 协议吗？*

相对于 HTTP 的用处，RPC 更多的是负责应用间的通信，所以性能要求相对更高。

* HTTP 协议的数据包相对于请求本身要大很多，有需要加入很多无用的内容，比如换行符号、回车符号等
* HTTP 协议是属于无状态协议，客户端无法对请求和响应进行关联(异步发送请求时)，每次请求都需要重新建立连接（HTTP 1.X），响应完成后再关闭连接

因此对于要求高性能的 RPC 来说，为了吞吐量会异步发送请求，需要知道哪个应答对应哪个请求，而HTTP 协议基本很难满足需求，所以 RPC 会选择设计更紧凑的私有协议。

## 协议的内容

RPC 每次请求发的大小都是不固定的，所以协议的设计需要让接收方能够正确的解析不定长的内容（确定消息边界）。就需要*约定*一个固定的长度，来存放整个请求数据大小，以及序列化方式。类似于这些需要固定长度存放的参数我们统称为“协议头”，这样整个协议就被拆分为：

* 协议头

  存放协议长度、序列化方式、协议标示、消息 ID (关联请求和响应) 、消息类型等

* 协议体

  请求接口方法、请求的业务参数值和一些扩展属性

![](https://static001.geekbang.org/resource/image/ac/2b/ac5f5236d972608fdb24c6eefce7e82b.jpg)

##### *固定长度的协议头如何扩展？*

协议头属于约定好了的定长协议头，如果后续需要往协议头里加参数，怎么办呢？

举个例子，假设一个 88 Bit 的协议头，然后你为了加入新功能，在协议头里面加了 2 bit，并且放到协议头的最后。升级后的应用，会用新的协议发出请求，然而没有升级的应用收到的请求后，还是按照 88 bit 读取协议头，新加的 2 个 bit 会当作协议体前 2 个 bit 数据读出来，但原本的协议体最后 2 个 bit 会被丢弃了，这样就会导致协议体的数据是错的。

*那如果将新加的参数放到不定长的协议体的扩展属性呢？*

虽然可以，但是接收方要读取协议体的内容是需要经过反序列化的，代价太高。

所以当把协议头再单独看为一个协议的话，也可以递归利用刚才的方法。协议头也设计成不定长的，在一个固定的地方存放协议头的长度。整体协议变成三部分内容：

* 固定部分
* 协议头
* 协议体

<img src="https://static001.geekbang.org/resource/image/2a/72/2a202f980458baca9fc50c53275c6772.jpg" style="zoom:80%;" />

